#!/bin/bash

# TODO(sean) determine where to get the password from
username="ubnt"
password="ubnt"

if ! dev=$(ls /dev/serial/by-id/usb-FTDI* | head -n 1); then
    echo "Network Switch Test: could not detect device FAIL"
    exit 1
fi

# required for standard io to work with serial console
stty -F "$dev" 115200 brkint -icrnl -imaxbel -opost -onlcr -isig -icanon -echo min 100 time 2

# try 20 actions before giving up
for _ in $(seq 20); do
    output=$(timeout 3 cat "$dev")
    case "$output" in
    *EdgeSwitch*\>)
        echo "show hardware" > "$dev"
        if timeout 3 grep -m 1 "Software Version" "$dev"; then
            echo "logout" > "$dev"
            echo "Network Switch Test: PASS"
            exit 0
        fi
        ;;
    *User:)
        echo "$username" > "$dev"
        ;;
    *Password:)
        echo "$password" > "$dev"
        ;;
    *)
        # "hit enter" so we can get more output
        echo > "$dev"
        ;;
    esac
done

echo "logout" > "$dev"
echo "Network Switch Test: could not detect version FAIL"
exit 2
