#!/bin/bash

stop() {
    echo "Modem0 Status Test:" "$2" "FAIL"
    exit "$1"
}

echo "Modem0 Status Test: Begin"

# check system manifest to see if this test needs to be done
if jq .connectivity.modem0.present /etc/waggle/node_manifest.json | grep -q false; then
    echo "Modem0 Status Test: no modem in manifest PASS"
    exit 0
fi

# if modem already has an ip address, then we know we're good.
if ip addr show dev modem0 2>/dev/null | grep -q "inet .*/32"; then
    echo "has ip address"
    exit 0
fi

# get first modem detected
if ! modem=$(mmcli -L | grep -m1 -o '/org/freedesktop/ModemManager1/Modem/[0-9]*'); then
    stop 1 "no modem found"
fi

# get modem info
if ! modeminfo=$(mmcli -K -m "$modem"); then
    stop 2 "failed to get modem info"
fi

if echo "$modeminfo" | grep -q 'modem.generic.state.* connected'; then
    echo "modem state is connected"
    exit 0
fi

if echo "$modeminfo" | grep -q 'modem.generic.state.* registered'; then
    echo "modem state is registered"
    exit 0
fi

# check for any known state failures
# TODO decide if manifest should allow this state for non-sim nodes
if echo "$modeminfo" | grep -q 'modem.generic.state-failed-reason.*sim-missing'; then
    stop 3 "sim is missing"
fi

# catch all other states as unknown failures
stop 4 "modem in unknown failure state"
